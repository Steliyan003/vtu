@model WebProject.Models.Product
@using System.Linq
@using System.Security.Claims

@{
    ViewData["Title"] = Model.Name;

    var hasReviews = Model.Reviews != null && Model.Reviews.Any();
    var avgRating = hasReviews ? Model.Reviews.Average(r => r.Rating) : 0;

    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<style>
    
    .rating {
        display: inline-flex;
        flex-direction: row-reverse; 
    }

        .rating input {
            display: none;
        }

        .rating label {
            font-size: 1.8rem;
            cursor: pointer;
            color: #bbb;
            margin: 0;
            padding: 0 2px;
            transition: color 0.15s ease-in-out;
        }

            
            .rating label:hover,
            .rating label:hover ~ label {
                color: #ffcc00;
            }

        
        .rating input:checked ~ label {
            color: #ffcc00;
        }

    
    .review-card {
        background-color: #222;
        border-radius: 0.75rem;
        border: 1px solid #333;
    }
</style>

<div class="row mt-4">

    
    <div class="col-12 mb-2">
        @if (TempData["ReviewSuccess"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                ✔ @TempData["ReviewSuccess"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        @if (TempData["ReviewError"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                ⚠ @TempData["ReviewError"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
    </div>

    <div class="col-md-6">
        <img src="@Model.ImageUrl"
             alt="@Model.Name"
             class="img-fluid rounded shadow-sm" />
    </div>

    <div class="col-md-6">
        <h2>@Model.Name</h2>

        <p class="text-muted">
            Категория:
            @Model.Category?.Name
        </p>

        <p class="fs-3 fw-bold text-primary">
            @Model.Price.ToString("0.00") лв.
        </p>

        
        <div class="mb-3">
            <strong>Оценка:</strong>
            @if (hasReviews)
            {
                for (int i = 1; i <= 5; i++)
                {
                    if (i <= Math.Round(avgRating))
                    {
                        @:<span style="color:#ffcc00;">★</span>
                    }
                    else
                    {
                        @:<span style="color:#bbb;">☆</span>
                    }
                }
                <span> (@avgRating.ToString("0.0") от @Model.Reviews.Count ревюта)</span>
            }
            else
            {
                <span>Няма оценки</span>
            }
        </div>

        <p class="mb-3">
            @Model.Description
        </p>

        <a asp-area=""
           asp-controller="Products"
           asp-action="Index"
           class="btn btn-outline-secondary mb-3">
            ⬅ Обратно към продуктите
        </a>

        
        <form asp-area=""
              asp-controller="Cart"
              asp-action="Add"
              method="post"
              class="mt-4">
            <input type="hidden" name="productId" value="@Model.Id" />

            <div class="input-group mb-3" style="max-width: 300px;">
                <label class="input-group-text" for="qty-@Model.Id">Брой</label>
                <select id="qty-@Model.Id" name="quantity" class="form-select">
                    @for (int q = 1; q <= 10; q++)
                    {
                        <option value="@q">@q</option>
                    }
                </select>
            </div>

            <button type="submit" class="btn btn-primary">
                Добави в количката
            </button>
        </form>

        
        @if (User.Identity.IsAuthenticated)
        {
            <h4 class="mt-4">Оцени продукта</h4>

            <form asp-area=""
                  asp-controller="Products"
                  asp-action="AddReview"
                  method="post"
                  class="mb-4">
                <input type="hidden" name="productId" value="@Model.Id" />

                
                <div class="rating mb-2">
                    <input type="radio" id="star5" name="rating" value="5" />
                    <label for="star5" title="5 звезди">★</label>

                    <input type="radio" id="star4" name="rating" value="4" />
                    <label for="star4" title="4 звезди">★</label>

                    <input type="radio" id="star3" name="rating" value="3" />
                    <label for="star3" title="3 звезди">★</label>

                    <input type="radio" id="star2" name="rating" value="2" />
                    <label for="star2" title="2 звезди">★</label>

                    <input type="radio" id="star1" name="rating" value="1" />
                    <label for="star1" title="1 звезда">★</label>
                </div>

                <textarea class="form-control"
                      name="content"
                      rows="3"
                      placeholder="Напиши своето мнение за продукта..."
                      required></textarea>

                <button type="submit" class="btn btn-primary mt-2">Публикувай ревю</button>
            </form>
        }
        else
        {
            <div class="alert alert-warning mt-4">
                <a asp-area="" asp-controller="Account" asp-action="Login">
                    Влез в профила си
                </a>, за да оставиш ревю и оценка.
            </div>
        }

    </div>
</div>

<hr class="mt-5 mb-4" />


<h3>Ревюта</h3>

@if (Model.Reviews == null || !Model.Reviews.Any())
{
    <p>Все още няма ревюта за този продукт.</p>
}
else
{
    foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedOn))
    {
        <div class="card review-card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>@review.User?.Email</strong><br />
                        <small class="text-muted">
                            @review.CreatedOn.ToString("dd.MM.yyyy HH:mm")
                        </small>
                    </div>
                    <div class="text-end">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= review.Rating)
                            {
                                @:<span style="color:#ffcc00;">★</span>
                            }
                            else
                            {
                                @:<span style="color:#bbb;">☆</span>
                            }
                        }

                        
                        @if (User.Identity.IsAuthenticated && review.UserId == currentUserId)
                        {
                            <form asp-area=""
                                  asp-controller="Products"
                                  asp-action="DeleteReview"
                                  method="post"
                                  class="d-inline ms-2"
                                  onsubmit="return confirm('Сигурни ли сте, че искате да изтриете това ревю?');">
                                <input type="hidden" name="reviewId" value="@review.Id" />
                                <input type="hidden" name="productId" value="@Model.Id" />
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    Изтрий
                                </button>
                            </form>
                        }
                    </div>
                </div>

                <p class="mt-2 mb-1">@review.Content</p>
            </div>
        </div>
    }
}
